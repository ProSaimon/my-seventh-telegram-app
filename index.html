<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .online-count {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .user {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .user:last-child {
            border-bottom: none;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #4285f4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        .status {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
        }
        
        .my-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
        }
        
        .error {
            color: #d32f2f;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        
        <div class="online-count">
            –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: <span id="count">0</span>
        </div>
        
        <div id="usersList">
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div class="my-info" id="myInfo">
            –í–∞—à ID: <span id="myId">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

<script>
// ===== –ü–†–û–°–¢–û–ô –†–ê–ë–û–ß–ò–ô –ö–û–î =====

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
function inTelegram() {
    return window.Telegram && window.Telegram.WebApp;
}

// 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserData() {
    // –ï—Å–ª–∏ –≤ Telegram
    if (inTelegram()) {
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe.user;
        
        if (user) {
            return {
                id: user.id,
                first_name: user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                last_name: user.last_name || '',
                username: user.username || ''
            };
        }
    }
    
    // –ï—Å–ª–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    let userId = localStorage.getItem('user_id');
    let userName = localStorage.getItem('user_name');
    
    if (!userId) {
        // –°–æ–∑–¥–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
        userId = Math.floor(100000 + Math.random() * 900000);
        userName = 'User_' + userId.toString().slice(-3);
        
        localStorage.setItem('user_id', userId);
        localStorage.setItem('user_name', userName);
    } else {
        userId = parseInt(userId);
    }
    
    return {
        id: userId,
        first_name: userName,
        last_name: '',
        username: ''
    };
}

// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function sendMyData() {
    const user = getUserData();
    
    try {
        const response = await fetch('/api/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(user)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, ID:', data.id);
            document.getElementById('myId').textContent = user.id;
            return true;
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            return false;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
        return false;
    }
}

// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
        }
        
        const users = await response.json();
        updateUserList(users);
        return true;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        document.getElementById('usersList').innerHTML = 
            '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</div>';
        return false;
    }
}

// 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function updateUserList(users) {
    const container = document.getElementById('usersList');
    const countElement = document.getElementById('count');
    
    if (!users || users.length === 0) {
        container.innerHTML = '<div class="user">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
        countElement.textContent = '0';
        return;
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ–±—è
    const currentUser = getUserData();
    const otherUsers = users.filter(u => u.id !== currentUser.id);
    
    countElement.textContent = otherUsers.length;
    
    if (otherUsers.length === 0) {
        container.innerHTML = '<div class="user">–í—ã –æ–¥–Ω–∏ –æ–Ω–ª–∞–π–Ω</div>';
        return;
    }
    
    container.innerHTML = otherUsers.map(user => `
        <div class="user">
            <div class="user-avatar">
                ${user.first_name ? user.first_name.charAt(0) : 'U'}
            </div>
            <div class="user-info">
                <div class="user-name">${user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                <div class="user-id">ID: ${user.id}</div>
            </div>
            <div class="status"></div>
        </div>
    `).join('');
}

// 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function initApp() {
    console.log('=== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Telegram
    if (inTelegram()) {
        console.log('üì± –ó–∞–ø—É—â–µ–Ω–æ –≤ Telegram');
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', tg.initDataUnsafe.user);
    } else {
        console.log('üåê –ó–∞–ø—É—â–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('myId').textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    document.getElementById('usersList').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
    const sent = await sendMyData();
    
    if (!sent) {
        document.getElementById('myId').textContent = '–æ—à–∏–±–∫–∞';
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    await loadUsers();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(loadUsers, 3000);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(sendMyData, 5000);
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>