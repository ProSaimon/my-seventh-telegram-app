<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
    <!-- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .online-counter {
            text-align: center;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .user-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        .my-info {
            margin-top: 20px;
            padding: 15px;
            background: #e6f7ff;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        
        <div class="online-counter">
            –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: <span id="count">0</span>
        </div>
        
        <div id="usersList">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div class="my-info">
            –í–∞—à ID Telegram: <span id="myId">...</span>
        </div>
    </div>

    <script>
        // ====== TELEGRAM MINI APP ======
        
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // 2. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –∏ –≥–æ–≤–æ—Ä–∏–º —á—Ç–æ –≥–æ—Ç–æ–≤—ã
        tg.expand();
        tg.ready();
        
        // 3. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const tgUser = tg.initDataUnsafe.user;
        
        // –ï—Å–ª–∏ Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        if (!tgUser) {
            document.getElementById('usersList').innerHTML = 
                '<div style="color: red; text-align: center;">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</div>';
            throw new Error('Telegram user data not available');
        }
        
        console.log('Telegram User:', tgUser);
        
        const myUserId = tgUser.id;
        const myFirstName = tgUser.first_name || '';
        const myLastName = tgUser.last_name || '';
        const myUsername = tgUser.username || '';
        const myPhotoUrl = tgUser.photo_url || '';
        
        // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('myId').textContent = myUserId;
        
        // 5. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendMyData() {
            const userData = {
                id: myUserId,
                first_name: myFirstName,
                last_name: myLastName,
                username: myUsername,
                photo_url: myPhotoUrl
            };
            
            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            }
        }
        
        // 6. –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                
                updateUserList(users);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            }
        }
        
        // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateUserList(users) {
            const usersList = document.getElementById('usersList');
            const countElement = document.getElementById('count');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = '<div class="loading">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
                countElement.textContent = '0';
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞
            const otherUsers = users.filter(user => user.id !== myUserId);
            
            countElement.textContent = otherUsers.length;
            
            if (otherUsers.length === 0) {
                usersList.innerHTML = '<div class="loading">–í—ã –æ–¥–Ω–∏ –æ–Ω–ª–∞–π–Ω</div>';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            usersList.innerHTML = otherUsers.map(user => `
                <div class="user-card">
                    <div class="user-avatar">
                        ${user.first_name ? user.first_name.charAt(0).toUpperCase() : 'T'}
                    </div>
                    <div class="user-info">
                        <div class="user-name">
                            ${user.first_name || ''} ${user.last_name || ''}
                            ${user.username ? `(@${user.username})` : ''}
                        </div>
                        <div class="user-id">ID: ${user.id}</div>
                    </div>
                    <div class="status"></div>
                </div>
            `).join('');
        }
        
        // 8. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function init() {
            console.log('üöÄ Telegram Mini App –∑–∞–ø—É—â–µ–Ω–∞');
            console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', tgUser);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
            await sendMyData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadUsers();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            setInterval(loadUsers, 3000);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(sendMyData, 5000);
        }
        
        // 9. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>